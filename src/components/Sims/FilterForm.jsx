import React, { Component, PropTypes } from 'react';
import { Form, Input, Button, Row, Col, Select, Cascaderm, message } from 'antd';
import styles from '../app.less';
import { connect } from 'react-redux';
import { toBase64 } from '../../services/common.js'
import { version } from '../../actions'
import xFetch, { getTokenOfCSRF } from '../../services/xFetch'

const Option = Select.Option;
const resName = 'simCards/indexes'
const selectSpan = {
  wrapperCol: { span: 16 },
  labelCol: { span: 8 },
  className: styles.formItemBox,
}
const selectSpan2 = {
  wrapperCol: { span: 24 },
  labelCol: { span: 0 },
  className: styles.formItemBox,
}
const gridSpan = {
  wrapperCol: { span: 14 },
  labelCol: { span: 4 },
  className: styles.formItemBox,
};
const ColSpan = 10;

const FormItem = Form.Item;

class FilterForm extends Component {
  constructor(props) {
    super()
    this.state = {
      pages1: [],
      boxes1: [],
      pages2: [],
      boxes2: [],
    }
  }
  getFromBook(num) {
    if (!num || num < 10000) {
      return undefined
    }
    const start = Math.floor(num / 10000)
    if (start < 10) {
      return `000${start}`
    } else if (10 <= start < 100) {
      return `00${start}`
    } else if (100 <= start < 1000) {
      return `0${start}`
    }
    return `${start}`
  }
  getFromPage(num) {
    if (!num || num < 10000) {
      return undefined
    }
    const start = Math.floor(num % 10000 / 100)
    return start > 9 ? `${start}` : `0${start}`
  }
  getFromBox(num) {
    if (!num || num < 10000) {
      return undefined
    }
    const start = num % 100;
    return start > 9 ? `${start}` : `0${start}`
  }
  //获得页数
  handleBooks1(book) {
    const singBook = { book: parseFloat(book) }
    const bookString = toBase64(singBook)
    const { dispatch } = this.props;
    const url = `/${version}/${resName}/pages?f=${bookString}`;
    xFetch(url).then(res => {
      const pages = res.jsonResult.data.data
      const list = pages.map(item => {
        return item < 10 ? `0${item}` : item
      })
      this.setState({
        pages1: list,
      })
    },
      error => {
        message.error(error)
      })
  }
  handleBooks2(book) {
    const singBook = { book: parseFloat(book) }
    const bookString = toBase64(singBook)
    const { dispatch } = this.props;
    const url = `/${version}/${resName}/pages?f=${bookString}`;
    xFetch(url).then(res => {
      const pages = res.jsonResult.data.data
      const list = pages.map(item => {
        return item < 10 ? `0${item}` : item
      })
      this.setState({
        pages2: list,
      })
    },
      error => {
        message.error(error)
      })
  }
  //获得格子数
  handlePages1(page) {
    const { form, dispatch } = this.props;
    const values = form.getFieldsValue();
    const { fromBooks } = values;
    const singPage = {
      book: parseFloat(fromBooks),
      page: parseFloat(page),
    }
    const pageString = toBase64(singPage)
    const url = `/${version}/${resName}/boxes?f=${pageString}`;
    xFetch(url)
      .then(res => {
        const boxes = res.jsonResult.data.data;
        const list = boxes.map(item => {
          return item < 10 ? `0${item}` : item
        })
        this.setState({
          boxes1: list,
        })
      },
      error => {
        message.error(error);
      }
      )
  }
  handlePages2(page) {
    const { form, dispatch } = this.props;
    const values = form.getFieldsValue();
    const { toBooks } = values;
    const singPage = {
      book: parseFloat(toBooks),
      page: parseFloat(page),
    }
    const pageString = toBase64(singPage)
    const url = `/${version}/${resName}/boxes?f=${pageString}`;
    xFetch(url)
      .then(res => {
        const boxes = res.jsonResult.data.data;
        const list = boxes.map(item => {
          return item < 10 ? `0${item}` : item
        })
        this.setState({
          boxes2: list,
        })
      },
      error => {
        message.error(error);
      }
      )
  }
  handleSubmit() {
    const { form, handleFilter } = this.props;
    form.validateFields((err, values) => {
      const { fromBooks, toBooks, fromPages, toPages,
        fromBoxes, toBoxes, company, mobile } = values;
      let index;
      if (!!fromBooks && !!fromPages && !!fromBoxes && !!toBooks && !!toPages && !!toBoxes) {
        index = [parseFloat(`${parseFloat(fromBooks)}${fromPages}${fromBoxes}`),
          parseFloat(`${parseFloat(toBooks)}${toPages}${toBoxes}`)];
      } else {
        index = undefined;
      }
      const makting = { company, mobile, index }
      handleFilter(makting);
    })
  }
  handleCancel() {
    const { handleClear, form } = this.props
    handleClear();
    form.resetFields();
    this.setState({ pages1: [], boxes1: [], pages2: [], boxes2: [] })
  }
  render() {
    const { form, filter = {}, position = {}, resources: { list } } = this.props
    const { books } = position
    const { pages1, pages2, boxes1, boxes2 } = this.state
    const { getFieldProps, setFieldsValue } = form;
    const { index = [] } = filter;
    const fromBook = this.getFromBook(index[0]);
    const toBook = this.getFromBook(index[1]);
    const fromPage = this.getFromPage(index[0]);
    const toPage = this.getFromPage(index[1]);
    const fromBox = this.getFromBox(index[0]);
    const toBox = this.getFromBox(index[1]);
    const companyName = [];
    const companyObj = {};
    list.forEach(item => {
      if (item.companyName !== '') {
        if (!companyObj[item.companyName]) {
          companyObj[item.companyName] = 1
          companyName.push(item.companyName)
        }
      }
    })
    return (
      <Form inline>
        <Row type="flex">
          <Col span={ColSpan}>
            <FormItem
              label="手机号"
              {...gridSpan}
            >
              <Input
                placeholder="请输入"
                {...getFieldProps('mobile')}
              />
            </FormItem>
          </Col>
          <Col span={ColSpan}>
            <FormItem
              id="channelFrom"
              label="所属渠道"
              {...gridSpan}
            >
              <Select
                placeholder="请选择"
                combobox
                {...getFieldProps('company')}
              >
                {companyName.map((item) => {
                  return <Option key={item} >{item}</Option>
                })}
              </Select>
            </FormItem>
          </Col>
        </Row>
        <Row>
          <Col span={5}>
            <FormItem
              label="卡位柜"
              {...selectSpan}
            >
              <Select
                placeholder="第几册"
                {...getFieldProps('fromBooks', {
                  initialValue: fromBook,
                })}
                onSelect={this.handleBooks1.bind(this)}
              >
                {books.map(value =>
                  <Option key={value}>{value}</Option>
                )}
              </Select>
            </FormItem>
          </Col>
          <Col span={3}>
            <FormItem
              {...selectSpan2}
            >
              <Select
                placeholder="第几页"
                {...getFieldProps('fromPages', {
                  initialValue: fromPage,
                })}
                onSelect={this.handlePages1.bind(this)}
              >
                {pages1.map(value =>
                  <Option key={value}>{value}</Option>
                )}
              </Select>
            </FormItem>
          </Col>
          <Col span={3}>
            <FormItem
              {...selectSpan2}
            >
              <Select
                placeholder="第几格"
                {...getFieldProps('fromBoxes', {
                  initialValue: fromBox,
                })}
              >
                {boxes1.map(value =>
                  <Option key={value}>{value}</Option>
                )}
              </Select>
            </FormItem>
          </Col>
          <Col span={5}>
            <FormItem
              label="至"
              {...selectSpan}
            >
              <Select
                placeholder="第几册"
                {...getFieldProps('toBooks', {
                  initialValue: toBook,
                })}
                onSelect={this.handleBooks2.bind(this)}
              >
                {books.map(value =>
                  <Option key={value}>{value}</Option>
                )}
              </Select>
            </FormItem>
          </Col>
          <Col span={3}>
            <FormItem
              {...selectSpan2}
            >
              <Select
                placeholder="第几页"
                {...getFieldProps('toPages', {
                  initialValue: toPage,
                })}
                onSelect={this.handlePages2.bind(this)}
              >
                {pages2.map(value =>
                  <Option key={value}>{value}</Option>
                )}
              </Select>
            </FormItem>
          </Col>
          <Col span={3}>
            <FormItem
              {...selectSpan2}
            >
              <Select
                placeholder="第几格"
                {...getFieldProps('toBoxes', {
                  initialValue: toBox,
                })}
              >
                {boxes2.map(value =>
                  <Option key={value}>{value}</Option>
                )}
              </Select>
            </FormItem>
          </Col>
        </Row>
        <br />
        <Row
          style={{ textAlign: 'right' }}
        >
          <Col span={24}>
            <Button
              type="primary"
              icon="search"
              style={{ marginRight: 10 }}
              onClick={this.handleSubmit.bind(this)}
            >搜索</Button>
            <Button
              onClick={this.handleCancel.bind(this)}
            >清除条件</Button>
          </Col>
        </Row>
      </Form>
    )
  }
}

const mapStateToProps = ({ filter, position, resources }) => {
  return {
    filter: Object.assign({}, { index: [] }, filter),
    position: Object.assign({}, { books: [], pages: [], boxes: [] }, position),
    resources: Object.assign({}, { list: [], pagination: {} }, resources.simCards),
  }
}

FilterForm.propTypese = {};

export default connect(mapStateToProps)(FilterForm);
